import copy
import os
import shutil
import time
from datetime import datetime
from pathlib import Path

import requests
from lxml import etree as ET

# ================== –ù–ê–°–¢–†–û–ô–ö–ò ==================
ROZETKA_URL = "http://parser.biz.ua/Aqua/api/export.aspx?action=rozetka&key=ui82P2VotQQamFTj512NQJK3HOlKvyv7"
EPICENTER_URL = "https://aqua-favorit.com.ua/content/export/e8965786f1dc7b09ba9950b66c9f7fba.xml"

TMP_DIR = Path("/tmp/epicenter_feed")
TMP_DIR.mkdir(parents=True, exist_ok=True)
ROZETKA_XML = TMP_DIR / "rozetka.xml"
EPICENTER_XML = TMP_DIR / "epicenter.xml"
OUTPUT_XML = TMP_DIR / "update_epicenter.xml"

# ===== –ß–Å–†–ù–´–ï –°–ü–ò–°–ö–ò =====
BANNED_VENDORS = {
    "Ariston",
    "Atlant",
    "Bosch",
    "Bradas",
    "Franke",
    "Mexen",
    "Neon",
    "NoName",
    "TeploCeramic",
    "Yoka",
    "–ù–æ–≤–∞—è –í–æ–¥–∞",
}

BANNED_CATEGORY_ROOTS = {"1276", "1278", "1157", "1252", "1251", "1199", "1161"}

# source categoryId -> (Epicenter code, Epicenter leaf category title)
CATEGORY_MAPPING = {
    "1009": ("962", "–í–∞–Ω–Ω–∏"),
    "1059": ("962", "–í–∞–Ω–Ω–∏"),
    "1060": ("962", "–í–∞–Ω–Ω–∏"),
    "1061": ("962", "–í–∞–Ω–Ω–∏"),
    "1062": ("962", "–í–∞–Ω–Ω–∏"),
    "1064": ("963", "–í–∞–Ω–Ω–∏ –≥—ñ–¥—Ä–æ–º–∞—Å–∞–∂–Ω—ñ"),
    "1065": ("963", "–í–∞–Ω–Ω–∏ –≥—ñ–¥—Ä–æ–º–∞—Å–∞–∂–Ω—ñ"),
    "1066": ("966", "–®—Ç–æ—Ä–∫–∏ –¥–ª—è –≤–∞–Ω–Ω"),
    "1200": ("966", "–®—Ç–æ—Ä–∫–∏ –¥–ª—è –≤–∞–Ω–Ω"),
    "1067": ("6905", "–ú–æ–Ω—Ç–∞–∂–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ —Ç–∞ –∞–∫—Å–µ—Å—É–∞—Ä–∏ –¥–ª—è –≤–∞–Ω–Ω"),
    "1149": ("6905", "–ú–æ–Ω—Ç–∞–∂–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ —Ç–∞ –∞–∫—Å–µ—Å—É–∞—Ä–∏ –¥–ª—è –≤–∞–Ω–Ω"),
    "1179": ("967", "–ù—ñ–∂–∫–∏ –¥–ª—è –≤–∞–Ω–Ω"),
    "1180": ("967", "–ù—ñ–∂–∫–∏ –¥–ª—è –≤–∞–Ω–Ω"),
    "1178": ("6905", "–ú–æ–Ω—Ç–∞–∂–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ —Ç–∞ –∞–∫—Å–µ—Å—É–∞—Ä–∏ –¥–ª—è –≤–∞–Ω–Ω"),
    "1181": ("6905", "–ú–æ–Ω—Ç–∞–∂–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ —Ç–∞ –∞–∫—Å–µ—Å—É–∞—Ä–∏ –¥–ª—è –≤–∞–Ω–Ω"),
    "1177": ("6905", "–ú–æ–Ω—Ç–∞–∂–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ —Ç–∞ –∞–∫—Å–µ—Å—É–∞—Ä–∏ –¥–ª—è –≤–∞–Ω–Ω"),
    "1150": ("965", "–ü–∞–Ω–µ–ª—ñ –¥–ª—è –≤–∞–Ω–Ω"),
    "1007": ("993", "–ó–º—ñ—à—É–≤–∞—á—ñ"),
    "1068": ("993", "–ó–º—ñ—à—É–≤–∞—á—ñ"),
    "1069": ("993", "–ó–º—ñ—à—É–≤–∞—á—ñ"),
    "1070": ("993", "–ó–º—ñ—à—É–≤–∞—á—ñ"),
    "1072": ("993", "–ó–º—ñ—à—É–≤–∞—á—ñ"),
    "1073": ("993", "–ó–º—ñ—à—É–≤–∞—á—ñ"),
    "1071": ("993", "–ó–º—ñ—à—É–≤–∞—á—ñ"),
    "1075": ("6924", "–ì—ñ–≥—ñ—î–Ω—ñ—á–Ω–∏–π –¥—É—à"),
    "1211": ("993", "–ó–º—ñ—à—É–≤–∞—á—ñ"),
    "1214": ("993", "–ó–º—ñ—à—É–≤–∞—á—ñ"),
    "1076": ("993", "–ó–º—ñ—à—É–≤–∞—á—ñ"),
    "1170": ("6914", "–ê–∫—Å–µ—Å—É–∞—Ä–∏ —Ç–∞ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—á—ñ –¥–ª—è –∑–º—ñ—à—É–≤–∞—á—ñ–≤"),
    "1217": ("993", "–ó–º—ñ—à—É–≤–∞—á—ñ"),
    "1218": ("993", "–ó–º—ñ—à—É–≤–∞—á—ñ"),
    "1242": ("1648", "–ó–∞–ø—ñ—Ä–Ω–∞ –∞—Ä–º–∞—Ç—É—Ä–∞"),
    "1080": ("974", "–£–Ω—ñ—Ç–∞–∑–∏ —Ç–∞ –∫–æ–º–ø–∞–∫—Ç–∏"),
    "1081": ("983", "–Ü–Ω—Å—Ç–∞–ª—è—Ü—ñ—ó"),
    "1082": ("974", "–£–Ω—ñ—Ç–∞–∑–∏ —Ç–∞ –∫–æ–º–ø–∞–∫—Ç–∏"),
    "1083": ("974", "–£–Ω—ñ—Ç–∞–∑–∏ —Ç–∞ –∫–æ–º–ø–∞–∫—Ç–∏"),
    "1084": ("974", "–£–Ω—ñ—Ç–∞–∑–∏ —Ç–∞ –∫–æ–º–ø–∞–∫—Ç–∏"),
    "1174": ("974", "–£–Ω—ñ—Ç–∞–∑–∏ —Ç–∞ –∫–æ–º–ø–∞–∫—Ç–∏"),
    "1085": ("977", "–ë—ñ–¥–µ"),
    "1201": ("983", "–Ü–Ω—Å—Ç–∞–ª—è—Ü—ñ—ó"),
    "1086": ("978", "–ü—ñ—Å—É–∞—Ä–∏"),
    "1087": ("980", "–ë–∞—á–∫–∏ –¥–ª—è —É–Ω—ñ—Ç–∞–∑–∞"),
    "1088": ("981", "–°–∏–¥—ñ–Ω–Ω—è —Ç–∞ –∫—Ä–∏—à–∫–∏ –¥–ª—è —É–Ω—ñ—Ç–∞–∑–∞"),
    "1089": ("981", "–°–∏–¥—ñ–Ω–Ω—è —Ç–∞ –∫—Ä–∏—à–∫–∏ –¥–ª—è —É–Ω—ñ—Ç–∞–∑–∞"),
    "1090": ("1654", "–°–∏—Ñ–æ–Ω–∏"),
    "1175": ("979", "–ß–∞—à—ñ –ì–µ–Ω—É—è"),
    "1094": ("976", "–ü'—î–¥–µ—Å—Ç–∞–ª–∏ –¥–ª—è —Ä–∞–∫–æ–≤–∏–Ω"),
    "1095": ("976", "–ü'—î–¥–µ—Å—Ç–∞–ª–∏ –¥–ª—è —Ä–∞–∫–æ–≤–∏–Ω"),
    "1096": ("976", "–ü'—î–¥–µ—Å—Ç–∞–ª–∏ –¥–ª—è —Ä–∞–∫–æ–≤–∏–Ω"),
    "1097": ("1654", "–°–∏—Ñ–æ–Ω–∏"),
    "1098": ("1654", "–°–∏—Ñ–æ–Ω–∏"),
    "1101": ("6922", "–î—É—à–æ–≤—ñ —Å–∏—Å—Ç–µ–º–∏"),
    "1102": ("6922", "–î—É—à–æ–≤—ñ —Å–∏—Å—Ç–µ–º–∏"),
    "1100": ("6917", "–î—É—à–æ–≤—ñ –Ω–∞–±–æ—Ä–∏"),
    "1099": ("9376", "–í–µ—Ä—Ö–Ω—ñ —Ç–∞ –±–æ–∫–æ–≤—ñ –¥—É—à—ñ"),
    "1109": ("9420", "–ö—Ä–æ–Ω—à—Ç–µ–π–Ω–∏ –¥–ª—è –¥—É—à—É"),
    "1103": ("6920", "–õ—ñ–π–∫–∏ –¥–ª—è –¥—É—à—É"),
    "1104": ("6921", "–®—Ç–∞–Ω–≥–∏, —Ç—Ä–∏–º–∞—á—ñ —Ç–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–ª—è –¥—É—à—É"),
    "1105": ("6916", "–®–ª–∞–Ω–≥–∏ –¥–ª—è –¥—É—à—É"),
    "1106": ("6921", "–®—Ç–∞–Ω–≥–∏, —Ç—Ä–∏–º–∞—á—ñ —Ç–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–ª—è –¥—É—à—É"),
    "1107": ("6921", "–®—Ç–∞–Ω–≥–∏, —Ç—Ä–∏–º–∞—á—ñ —Ç–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–ª—è –¥—É—à—É"),
    "1108": ("9376", "–í–µ—Ä—Ö–Ω—ñ —Ç–∞ –±–æ–∫–æ–≤—ñ –¥—É—à—ñ"),
    "1156": ("6914", "–ê–∫—Å–µ—Å—É–∞—Ä–∏ —Ç–∞ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—á—ñ –¥–ª—è –∑–º—ñ—à—É–≤–∞—á—ñ–≤"),
    "1110": ("969", "–î—É—à–æ–≤—ñ –∫–∞–±—ñ–Ω–∏"),
    "1114": ("970", "–ì—ñ–¥—Ä–æ–º–∞—Å–∞–∂–Ω—ñ –±–æ–∫—Å–∏"),
    "1111": ("971", "–î—É—à–æ–≤—ñ –ø—ñ–¥–¥–æ–Ω–∏"),
    "1116": ("6636", "–¢—Ä–∞–ø–∏"),
    "1117": ("6636", "–¢—Ä–∞–ø–∏"),
    "1112": ("972", "–î—É—à–æ–≤—ñ –¥–≤–µ—Ä—ñ —Ç–∞ —Å—Ç—ñ–Ω–∫–∏"),
    "1113": ("972", "–î—É—à–æ–≤—ñ –¥–≤–µ—Ä—ñ —Ç–∞ —Å—Ç—ñ–Ω–∫–∏"),
    "1118": ("1654", "–°–∏—Ñ–æ–Ω–∏"),
    "1157": ("6908", "–ö–æ–º–ø–ª–µ–∫—Ç—É—é—á—ñ —Ç–∞ –∞–∫—Å–µ—Å—É–∞—Ä–∏ –¥–ª—è –¥—É—à–æ–≤–∏—Ö –∫–∞–±—ñ–Ω —Ç–∞ –±–æ–∫—Å—ñ–≤"),
    "1121": ("983", "–Ü–Ω—Å—Ç–∞–ª—è—Ü—ñ—ó"),
    "1127": ("983", "–Ü–Ω—Å—Ç–∞–ª—è—Ü—ñ—ó"),
    "1122": ("983", "–Ü–Ω—Å—Ç–∞–ª—è—Ü—ñ—ó"),
    "1123": ("983", "–Ü–Ω—Å—Ç–∞–ª—è—Ü—ñ—ó"),
    "1124": ("983", "–Ü–Ω—Å—Ç–∞–ª—è—Ü—ñ—ó"),
    "1125": ("983", "–Ü–Ω—Å—Ç–∞–ª—è—Ü—ñ—ó"),
    "1126": ("984", "–ö–ª–∞–≤—ñ—à—ñ –∑–º–∏–≤—É —Ç–∞ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—á—ñ"),
    "1128": ("984", "–ö–ª–∞–≤—ñ—à—ñ –∑–º–∏–≤—É —Ç–∞ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—á—ñ"),
    "1129": ("988", "–î–∑–µ—Ä–∫–∞–ª–∞ –¥–ª—è –≤–∞–Ω–Ω–æ—ó –∫—ñ–º–Ω–∞—Ç–∏"),
    "1133": ("988", "–î–∑–µ—Ä–∫–∞–ª–∞ –¥–ª—è –≤–∞–Ω–Ω–æ—ó –∫—ñ–º–Ω–∞—Ç–∏"),
    "1130": ("989", "–®–∞—Ñ–∏ —Ç–∞ –ø–µ–Ω–∞–ª–∏ –¥–ª—è –≤–∞–Ω–Ω–æ—ó –∫—ñ–º–Ω–∞—Ç–∏"),
    "1132": ("987", "–¢—É–º–±–∏ –¥–ª—è –≤–∞–Ω–Ω–æ—ó –∫—ñ–º–Ω–∞—Ç–∏"),
    "1131": ("987", "–¢—É–º–±–∏ –¥–ª—è –≤–∞–Ω–Ω–æ—ó –∫—ñ–º–Ω–∞—Ç–∏"),
    "1232": ("987", "–¢—É–º–±–∏ –¥–ª—è –≤–∞–Ω–Ω–æ—ó –∫—ñ–º–Ω–∞—Ç–∏"),
    "1176": ("3561", "–°—Ç—ñ–ª—å–Ω–∏—Ü—ñ —ñ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—á—ñ –¥–ª—è –≤–∞–Ω–Ω–æ—ó –∫—ñ–º–Ω–∞—Ç–∏"),
    "1202": ("987", "–¢—É–º–±–∏ –¥–ª—è –≤–∞–Ω–Ω–æ—ó –∫—ñ–º–Ω–∞—Ç–∏"),
    "1134": ("3561", "–°—Ç—ñ–ª—å–Ω–∏—Ü—ñ —ñ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—á—ñ –¥–ª—è –≤–∞–Ω–Ω–æ—ó –∫—ñ–º–Ω–∞—Ç–∏"),
    "1166": ("4600", "–ú–∏–π–∫–∏ –¥–ª—è –∫—É—Ö–Ω—ñ"),
    "1224": ("993", "–ó–º—ñ—à—É–≤–∞—á—ñ"),
    "1169": ("1654", "–°–∏—Ñ–æ–Ω–∏"),
    "1140": ("6508", "–ù–∞–±–æ—Ä–∏ –∞–∫—Å–µ—Å—É–∞—Ä—ñ–≤"),
    "1142": ("6626", "–ì–∞—á–∫–∏ —Ç–∞ –ø–ª–∞–Ω–∫–∏ –¥–ª—è –≤–∞–Ω–Ω–æ—ó –∫—ñ–º–Ω–∞—Ç–∏"),
    "1265": ("6594", "–¢—Ä–∏–º–∞—á—ñ –¥–ª—è –≤–∞–Ω–Ω–æ—ó –∫—ñ–º–Ω–∞—Ç–∏"),
    "1136": ("6624", "–¢—Ä–∏–º–∞—á—ñ –¥–ª—è —Ä—É—à–Ω–∏–∫—ñ–≤"),
    "1137": ("6620", "–¢—Ä–∏–º–∞—á—ñ –¥–ª—è —Ç—É–∞–ª–µ—Ç–Ω–æ–≥–æ –ø–∞–ø–µ—Ä—É"),
    "1143": ("6873", "–ú–∏–ª—å–Ω–∏—Ü—ñ"),
    "1138": ("6619", "–î–æ–∑–∞—Ç–æ—Ä–∏ –¥–ª—è —Ä—ñ–¥–∫–æ–≥–æ –º–∏–ª–∞"),
    "1145": ("6543", "–¢—Ä–∏–º–∞—á—ñ –¥–ª—è –∑—É–±–Ω–∏—Ö —â—ñ—Ç–æ–∫"),
    "1144": ("991", "–ü–æ–ª–∏—Ü—ñ –¥–ª—è –≤–∞–Ω–Ω–æ—ó –∫—ñ–º–Ω–∞—Ç–∏"),
    "1139": ("6629", "–ô–æ—Ä–∂–∏–∫–∏ –¥–ª—è —É–Ω—ñ—Ç–∞–∑–∞"),
    "1189": ("1002", "–°—Ç—ñ–π–∫–∏ –¥–ª—è –≤–∞–Ω–Ω–æ—ó –∫—ñ–º–Ω–∞—Ç–∏"),
    "1135": ("999", "–í—ñ–¥—Ä–∞ —Ç–∞ –∫–æ—à–∏–∫–∏ –¥–ª—è –≤–∞–Ω–Ω–æ—ó –∫—ñ–º–Ω–∞—Ç–∏"),
    "1171": ("6854", "–ü–æ—Ä—É—á–Ω—ñ –¥–ª—è –≤–∞–Ω–Ω–∏"),
    "1141": ("6502", "–ö–æ—Å–º–µ—Ç–∏—á–Ω—ñ –¥–∑–µ—Ä–∫–∞–ª–∞"),
    "1190": ("999", "–í—ñ–¥—Ä–∞ —Ç–∞ –∫–æ—à–∏–∫–∏ –¥–ª—è –≤–∞–Ω–Ω–æ—ó –∫—ñ–º–Ω–∞—Ç–∏"),
    "1205": ("6544", "–°—É—à–∞—Ä–∫–∏ –¥–ª—è —Ä—É–∫"),
    "1206": ("2788", "–§–µ–Ω–∏"),
    "1264": ("6619", "–î–æ–∑–∞—Ç–æ—Ä–∏ –¥–ª—è —Ä—ñ–¥–∫–æ–≥–æ –º–∏–ª–∞"),
    "1219": ("6619", "–î–æ–∑–∞—Ç–æ—Ä–∏ –¥–ª—è —Ä—ñ–¥–∫–æ–≥–æ –º–∏–ª–∞"),
    "1173": ("6908", "–ö–æ–º–ø–ª–µ–∫—Ç—É—é—á—ñ —Ç–∞ –∞–∫—Å–µ—Å—É–∞—Ä–∏ –¥–ª—è –¥—É—à–æ–≤–∏—Ö –∫–∞–±—ñ–Ω —Ç–∞ –±–æ–∫—Å—ñ–≤"),
    "1212": ("999", "–í—ñ–¥—Ä–∞ —Ç–∞ –∫–æ—à–∏–∫–∏ –¥–ª—è –≤–∞–Ω–Ω–æ—ó –∫—ñ–º–Ω–∞—Ç–∏"),
    "1191": ("1001", "–ö–∏–ª–∏–º–∫–∏ –¥–ª—è –≤–∞–Ω–Ω–æ—ó –∫—ñ–º–Ω–∞—Ç–∏"),
    "1120": ("1005", "–†—É—à–Ω–∏–∫–æ—Å—É—à–∞—Ä–∫–∏ –µ–ª–µ–∫—Ç—Ä–∏—á–Ω—ñ"),
    "1119": ("1004", "–†—É—à–Ω–∏–∫–æ—Å—É—à–∞—Ä–∫–∏ –≤–æ–¥—è–Ω—ñ"),
    "1215": ("6919", "–†–∞–¥—ñ–∞—Ç–æ—Ä–∏ –¥–∏–∑–∞–π–Ω–µ—Ä—Å—å–∫—ñ"),
    "1262": ("1615", "–¢–µ—Ä–º–æ—Ä–µ–≥—É–ª—é—é—á–∞ –∞—Ä–º–∞—Ç—É—Ä–∞"),
    "1213": ("1005", "–†—É—à–Ω–∏–∫–æ—Å—É—à–∞—Ä–∫–∏ –µ–ª–µ–∫—Ç—Ä–∏—á–Ω—ñ"),
    "1167": ("5461", "–ö–æ–º–ø–ª–µ–∫—Ç—É—é—á—ñ –¥–ª—è —Ä—É—à–Ω–∏–∫–æ—Å—É—à–∞—Ä–æ–∫"),
    "1158": ("3541", "–ü–æ–±—É—Ç–æ–≤—ñ –≤–∏—Ç—è–∂–Ω—ñ –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–∏"),
    "1159": ("3539", "–ü–æ–≤—ñ—Ç—Ä–æ–ø—Ä–æ–≤–æ–¥–∏ —Ç–∞ –º–æ–Ω—Ç–∞–∂–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏"),
    "1276": ("3540", "–í–µ–Ω—Ç–∏–ª—è—Ü—ñ–π–Ω—ñ —Ä–µ—à—ñ—Ç–∫–∏"),
    "1277": ("4949", "–ê–≤—Ç–æ–º–∞—Ç–∏–∫–∞"),
    "1278": ("3539", "–ü–æ–≤—ñ—Ç—Ä–æ–ø—Ä–æ–≤–æ–¥–∏ —Ç–∞ –º–æ–Ω—Ç–∞–∂–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏"),
    "1275": ("3544", "–†–µ–∫—É–ø–µ—Ä–∞—Ç–æ—Ä–∏"),
    "1228": ("4985", "–¢–µ–ø–ª–æ–≤—ñ –ø–∞–Ω–µ–ª—ñ"),
    "1227": ("4985", "–¢–µ–ø–ª–æ–≤—ñ –ø–∞–Ω–µ–ª—ñ"),
    "1226": ("4985", "–¢–µ–ø–ª–æ–≤—ñ –ø–∞–Ω–µ–ª—ñ"),
    "1266": ("4912", "–Ü–Ω—Ñ—Ä–∞—á–µ—Ä–≤–æ–Ω—ñ –æ–±—ñ–≥—Ä—ñ–≤–∞—á—ñ"),
    "1271": ("1625", "–¢–µ–ø–ª–∞ –ø—ñ–¥–ª–æ–≥–∞ –µ–ª–µ–∫—Ç—Ä–∏—á–Ω–∞"),
    "1272": ("1625", "–¢–µ–ø–ª–∞ –ø—ñ–¥–ª–æ–≥–∞ –µ–ª–µ–∫—Ç—Ä–∏—á–Ω–∞"),
    "1160": ("1619", "–ë–æ–π–ª–µ—Ä–∏"),
    "1233": ("1620", "–ì–∞–∑–æ–≤—ñ –∫–æ–ª–æ–Ω–∫–∏"),
    "1231": ("1604", "–ö–æ—Ç–ª–∏ –≥–∞–∑–æ–≤—ñ"),
    "1234": ("1605", "–ö–æ—Ç–ª–∏ –µ–ª–µ–∫—Ç—Ä–∏—á–Ω—ñ"),
    "1259": ("1606", "–ö–æ—Ç–ª–∏ —Ç–≤–µ—Ä–¥–æ–ø–∞–ª–∏–≤–Ω—ñ"),
    "1235": ("1609", "–ö–æ–º–ø–ª–µ–∫—Ç—É—é—á—ñ –¥–ª—è –∫–æ—Ç–ª—ñ–≤ —Ç–∞ –¥–æ–ø–æ–º—ñ–∂–Ω–µ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è"),
    "1223": ("1666", "–í–æ–¥–æ–ø—Ä–æ–≤—ñ–¥–Ω—ñ –Ω–∞—Å–æ—Å–∏"),
    "1249": ("1648", "–ó–∞–ø—ñ—Ä–Ω–∞ –∞—Ä–º–∞—Ç—É—Ä–∞"),
    "1250": ("1648", "–ó–∞–ø—ñ—Ä–Ω–∞ –∞—Ä–º–∞—Ç—É—Ä–∞"),
    "1253": ("1647", "–®–ª–∞–Ω–≥–∏ –¥–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è"),
    "1255": ("7985", "–ö–æ–ª–µ–∫—Ç–æ—Ä–∏ –≤–æ–¥–æ–ø—Ä–æ–≤—ñ–¥–Ω—ñ"),
    "1251": ("6607", "–ú–µ—Ç–∞–ª–æ–ø–ª–∞—Å—Ç–∏–∫–æ–≤—ñ —Ç—Ä—É–±–∏"),
    "1257": ("5349", "–í–Ω—É—Ç—Ä—ñ—à–Ω—è –∫–∞–Ω–∞–ª—ñ–∑–∞—Ü—ñ—è"),
    "1254": ("6906", "–§—ñ—Ç–∏–Ω–≥–∏ —Ä—ñ–∑—å–±–æ–≤—ñ"),
    "1256": ("5349", "–í–Ω—É—Ç—Ä—ñ—à–Ω—è –∫–∞–Ω–∞–ª—ñ–∑–∞—Ü—ñ—è"),
    "1245": ("1640", "–õ—ñ—á–∏–ª—å–Ω–∏–∫–∏ –≤–æ–¥–∏"),
    "1273": ("1609", "–ö–æ–º–ø–ª–µ–∫—Ç—É—é—á—ñ –¥–ª—è –∫–æ—Ç–ª—ñ–≤ —Ç–∞ –¥–æ–ø–æ–º—ñ–∂–Ω–µ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è"),
    "1274": ("1609", "–ö–æ–º–ø–ª–µ–∫—Ç—É—é—á—ñ –¥–ª—è –∫–æ—Ç–ª—ñ–≤ —Ç–∞ –¥–æ–ø–æ–º—ñ–∂–Ω–µ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è"),
}

# ================== TELEGRAM ==================
TG_BOT_TOKEN = os.environ.get("TELEGRAM_BOT_TOKEN")
TG_CHAT_ID = os.environ.get("TELEGRAM_CHAT_ID")


def send_telegram(message: str) -> None:
    if not TG_BOT_TOKEN or not TG_CHAT_ID:
        print("‚ö† TELEGRAM_BOT_TOKEN –∏–ª–∏ TELEGRAM_CHAT_ID –Ω–µ –∑–∞–¥–∞–Ω. –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.")
        return
    url = f"https://api.telegram.org/bot{TG_BOT_TOKEN}/sendMessage"
    payload = {"chat_id": TG_CHAT_ID, "text": message, "parse_mode": "HTML"}
    try:
        response = requests.post(url, data=payload, timeout=10)
        response.raise_for_status()
    except Exception as exc:
        print(f"‚ö† –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram: {exc}")


# ================== –°–ö–ê–ß–ò–í–ê–ù–ò–ï ==================
def download_file(url: str, path: Path, title: str, retries: int = 5, timeout: int = 180) -> None:
    print(f"‚ñ∂ –ó–∞–≥—Ä—É–∑–∫–∞: {title}")
    for attempt in range(1, retries + 1):
        try:
            response = requests.get(url, stream=True, timeout=timeout)
            response.raise_for_status()
            with open(path, "wb") as file_obj:
                for chunk in response.iter_content(1024 * 1024):
                    if chunk:
                        file_obj.write(chunk)
            print(f" ‚úÖ {title} –∑–∞–≥—Ä—É–∂–µ–Ω\n")
            return
        except Exception as exc:
            print(f" ‚ö† –û—à–∏–±–∫–∞: {exc}")
            if attempt == retries:
                raise
            time.sleep(5)


print("\n===== –°–¢–ê–†–¢ =====\n")
download_file(ROZETKA_URL, ROZETKA_XML, "–†–æ–∑–µ—Ç–∫–∞ XML")
download_file(EPICENTER_URL, EPICENTER_XML, "–≠–ø–∏—Ü–µ–Ω—Ç—Ä XML")

# ================== –†–û–ó–ï–¢–ö–ê ==================
rozetka_data = {}
tree_r = ET.parse(str(ROZETKA_XML))
for offer in tree_r.xpath("//offer"):
    rid = (offer.get("id") or "").strip()
    if rid:
        rozetka_data[rid] = {
            "price": offer.findtext("price", "").strip(),
            "old_price": offer.findtext("oldprice", "").strip(),
            "available": offer.get("available", "").strip(),
        }

# ================== –≠–ü–ò–¶–ï–ù–¢–† ==================
tree = ET.parse(str(EPICENTER_XML))
root = tree.getroot()
category_parent = {cat.get("id"): cat.get("parentId") for cat in root.xpath("//category")}


def is_banned_category(category_id: str) -> bool:
    while category_id:
        if category_id in BANNED_CATEGORY_ROOTS:
            return True
        category_id = category_parent.get(category_id)
    return False


new_root = ET.Element("yml_catalog", date=datetime.now().strftime("%Y-%m-%d %H:%M"))
new_offers = ET.SubElement(new_root, "offers")

removed = 0
mapped = 0
unmapped = 0

for offer in root.xpath("//offer"):
    vendor = offer.findtext("vendor", "").strip()
    src_category_id = offer.findtext("categoryId", "").strip()

    if vendor in BANNED_VENDORS or is_banned_category(src_category_id):
        removed += 1
        continue

    offer_copy = copy.deepcopy(offer)
    offer_copy.attrib.pop("group_id", None)
    url_node = offer_copy.find("url")
    if url_node is not None:
        offer_copy.remove(url_node)

    # –∞—Ä—Ç–∏–∫—É–ª -> id
    vendor_code = offer_copy.findtext("vendorCode", "").strip()
    param_artikul = offer_copy.find(".//param[@name='–ê—Ä—Ç–∏–∫—É–ª']")

    if param_artikul is not None and (param_artikul.text or "").strip():
        offer_id = param_artikul.text.strip()
    elif vendor_code:
        offer_id = vendor_code
    else:
        offer_id = (offer_copy.get("id") or "").strip()

    if offer_id:
        offer_copy.set("id", offer_id)

    # –æ–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—ã –∏ –Ω–∞–ª–∏—á–∏–µ –∏–∑ —Ä–æ–∑–µ—Ç–∫–∏
    if offer_id in rozetka_data:
        data = rozetka_data[offer_id]
        price_node = offer_copy.find("price")
        if data["price"] and price_node is not None:
            price_node.text = data["price"]
        if data["old_price"]:
            old = offer_copy.find("oldprice")
            if old is None:
                old = ET.SubElement(offer_copy, "oldprice")
            old.text = data["old_price"]
        if data["available"]:
            offer_copy.set("available", data["available"])

    # name / description -> lang tags
    name = offer_copy.find("name")
    name_ua = offer_copy.find("name_ua")
    if name is not None:
        name.tag = "name"
        name.set("lang", "ru")
    if name_ua is not None:
        name_ua.tag = "name"
        name_ua.set("lang", "ua")

    description = offer_copy.find("description")
    description_ua = offer_copy.find("description_ua")
    if description is not None:
        description.tag = "description"
        description.set("lang", "ru")
    if description_ua is not None:
        description_ua.tag = "description"
        description_ua.set("lang", "ua")

    # oldprice -> price_old
    for oldprice_elem in offer_copy.xpath(".//oldprice"):
        oldprice_elem.tag = "price_old"

    # categoryId -> category + attribute_set (Epicenter format)
    mapped_category = CATEGORY_MAPPING.get(src_category_id)
    category_id_node = offer_copy.find("categoryId")
    if category_id_node is not None:
        offer_copy.remove(category_id_node)

    if mapped_category:
        mapped += 1
        ep_code, ep_name = mapped_category
    else:
        unmapped += 1
        ep_code = src_category_id or "0"
        ep_name = "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó"

    category_node = ET.Element("category", code=ep_code)
    category_node.text = ep_name
    attribute_set_node = ET.Element("attribute_set", code=ep_code)
    attribute_set_node.text = ep_name

    insert_pos = 2 if len(offer_copy) >= 2 else len(offer_copy)
    offer_copy.insert(insert_pos, category_node)
    offer_copy.insert(insert_pos + 1, attribute_set_node)

    # —É–±—Ä–∞—Ç—å –≤—Å–µ param –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é: –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤
    for param in offer_copy.xpath(".//param"):
        parent = param.getparent()
        if parent is not None:
            parent.remove(param)

    new_offers.append(offer_copy)

# ================== –°–û–•–†–ê–ù–ï–ù–ò–ï ==================
tree_new = ET.ElementTree(new_root)
tree_new.write(str(OUTPUT_XML), encoding="UTF-8", xml_declaration=True, pretty_print=True)
shutil.copy2(OUTPUT_XML, Path.cwd() / "update_epicenter.xml")

# ================== TELEGRAM ==================
message = f"""===== –°–¢–ê–†–¢ =====
‚ñ∂ –ó–∞–≥—Ä—É–∑–∫–∞: –†–æ–∑–µ—Ç–∫–∞ XML
‚úÖ –†–æ–∑–µ—Ç–∫–∞ XML –∑–∞–≥—Ä—É–∂–µ–Ω
‚ñ∂ –ó–∞–≥—Ä—É–∑–∫–∞: –≠–ø–∏—Ü–µ–Ω—Ç—Ä XML
‚úÖ –≠–ø–∏—Ü–µ–Ω—Ç—Ä XML –∑–∞–≥—Ä—É–∂–µ–Ω
‚ùå –£–¥–∞–ª–µ–Ω–æ –∏–∑ —Ñ–∞–π–ª–∞ (–ª–µ–≤—ã—Ö) —Ç–æ–≤–∞—Ä–æ–≤: {removed}
üóÇ –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: {mapped}
‚ö† –ù–µ –Ω–∞–π–¥–µ–Ω–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ —Ç–∞–±–ª–∏—Ü–µ: {unmapped}
üì¶ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≠–ø–∏—Ü–µ–Ω—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤: {len(new_offers.xpath('offer'))}
===== –ì–û–¢–û–í–û ‚úÖ ====="""

send_telegram(message)
print(message)
